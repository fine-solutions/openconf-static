const postcss = require('postcss')
const postcssImport = require('postcss-import')
const postcssMediaMinmax = require('postcss-media-minmax')
const autoprefixer = require('autoprefixer')
const postcssCsso = require('postcss-csso')
const htmlMin = require('html-minifier-terser')
const { parseHTML } = require('linkedom')

module.exports = function (config) {
  // Settings
  config.setDataDeepMerge(true)
  config.addTemplateFormats('css')

  // Plugins
  // Extensions
  config.addExtension('css', {
    outputFileExtension: 'css',
    compile: async (content, path) => {
      if (![ './src/styles/index.css', './src/styles/dark-theme.css' ].includes(path)) {
        return
      }

      const result = await postcss([
        postcssImport,
        postcssMediaMinmax,
        autoprefixer,
        postcssCsso,
      ]).process(content, {
        from: path,
      })

      return async () => {
        return result.css
      }
    }
  })

  // Collections
  // Libraries
  // NunjucksShortcodes
  // Filters
  // Transforms
  config.addTransform('html-minify', (content, path) => {
    if (path && path.endsWith('.html')) {
      return htmlMin.minify(
        content, {
          collapseBooleanAttributes: true,
          collapseWhitespace: true,
          decodeEntities: true,
          includeAutoGeneratedTags: false,
          removeComments: true,
        }
      )
    }

    return content
  })

  config.addTransform('unused-font-remover', (content, outputPath) => {
    if (outputPath && outputPath.endsWith('.html')) {
      const window = parseHTML(content)
      const isCaptionExists = !!window.document.querySelector('.caption')
      const isInputExists = !!window.document.querySelector('.input')
      const isTitleExists = !!window.document.querySelector('.title')
      const isValueExists = !!window.document.querySelector('.value')
      const isTextExists = !!window.document.querySelector('.text')
      const isTagExists = !!window.document.querySelector('.tag')
      const isStrongExists = !!window.document.querySelector('.strong')
      const isMenuExists = !!window.document.querySelector('.menu')

      if (!isInputExists && !isTagExists && !isMenuExists) {
        window.document.querySelector("link[href='/fonts/RobotoMono/RobotoMono-Regular.woff2']").remove()
      }
      if (!isCaptionExists && !isTitleExists) {
        window.document.querySelector("link[href='/fonts/RobotoMono/RobotoMono-Bold.woff2']").remove()
      }
      if (!isValueExists) {
        window.document.querySelector("link[href='/fonts/RobotoMono/RobotoMono-Light.woff2']").remove()
      }
      if (!isTextExists) {
        window.document.querySelector("link[href='/fonts/Roboto/Roboto-Regular.woff2']").remove()
      }
      if (!isStrongExists) {
        window.document.querySelector("link[href='/fonts/Roboto/Roboto-Semibold.woff2']").remove()
      }
    }

    return content
  })

  // PassthroughCopy
  config.addPassthroughCopy('src/favicon.ico')
  config.addPassthroughCopy('src/manifest.json')
  config.addPassthroughCopy('src/robots.txt')
  config.addPassthroughCopy('src/fonts')
  config.addPassthroughCopy('src/images')

  // Return
  return {
    dir: {
      input: 'src',
      output: 'dist',
      includes: 'includes',
      layouts: 'layouts',
      data: 'data',
    },
    dataTemplateEngine: 'njk',
    markdownTemplateEngine: false,
    htmlTemplateEngine: 'njk',
    passthroughFileCopy: true,
    templateFormats: ['md', 'njk'],
  }
}
